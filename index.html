<!DOCTYPE ahtml>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ファイル共有 (PWA対応)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PWA用のメタタグを追加 -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="IMG_1436.png" sizes="192x192" type="image/png">
  <meta name="theme-color" content="#008BF2">

  <!-- Tailwind CSSを読み込み、モダンなデザインに -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f6f8;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      width: 100%;
      /* 広い画面では左右に並べるために、カードの最大幅をなくす */
      max-width: none;
      margin: 2rem auto;
    }
    .progress-bar {
      width: 100%;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
      height: 14px;
    }
    .progress-bar-fill {
      background: #4caf50;
      width: 0%;
      height: 100%;
      transition: width 0.3s ease;
    }
    #qrCanvas canvas, #urlQrCanvas canvas {
        margin-top: 1rem;
        display: block;
        width: 100%;
        height: auto;
    }
    .file-list {
      margin-top: 1rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
    }
  </style>
</head>
<body class="p-4 md:p-8">
  <!-- 広い画面ではflexboxを使い、カードを横並びに配置 -->
  <!-- items-stretchを追加して高さを揃える -->
  <div class="md:flex md:space-x-8 md:items-stretch md:justify-center">
    <!-- 送信カード -->
    <div class="card md:flex-1">
      <h2 class="text-xl font-bold mb-4 text-center">送信</h2>
      <label class="block text-gray-700 font-semibold mb-2">ファイルを選択:</label>
      <input type="file" id="fileInput" multiple class="block w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <button id="shareBtn" class="w-full mt-4 bg-[#008BF2] text-white font-semibold py-2 rounded-lg hover:bg-blue-500 transition duration-200">共有リンクを生成</button>
      
      <div class="progress-bar"><div id="sendProgress" class="progress-bar-fill"></div></div>
      <p id="sendTimeRemaining" class="text-sm text-gray-500 text-center mt-2"></p>
      
      <div id="sharingFileList" class="file-list hidden">
        <h3 class="font-bold mb-2">共有中のファイル:</h3>
        <ul id="sharingFileUl"></ul>
      </div>

      <textarea id="magnetDisplay" readonly rows="3" placeholder="共有リンクがここに表示されます" class="w-full p-3 mt-4 text-sm bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
      <div id="qrCanvas" class="flex justify-center mt-4"></div>
    </div>

    <!-- 受信カード -->
    <div class="card md:flex-1">
      <h2 class="text-xl font-bold mb-4 text-center">受信</h2>
      
      <!-- カメラ選択ドロップダウンメニューを追加 -->
      <div class="mb-4">
        <label for="cameraSelect" class="block text-gray-700 font-semibold mb-2">カメラを選択:</label>
        <select id="cameraSelect" class="w-full p-3 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
      </div>

      <button id="scanBtn" class="w-full bg-[#008BF2] text-white font-semibold py-2 rounded-lg hover:bg-blue-500 transition duration-200">QRを読み取る</button>
      <div id="reader" style="max-width: 400px; margin: 1rem auto;"></div>
      
      <label class="block text-gray-700 font-semibold mt-4 mb-2">magnet URI:</label>
      <input type="text" id="magnetInput" placeholder="magnet:?xt=..." class="w-full p-3 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
      <button id="downloadBtn" class="w-full mt-4 bg-[#008BF2] text-white font-semibold py-2 rounded-lg hover:bg-blue-500 transition duration-200">受信を開始</button>
      
      <div class="progress-bar"><div id="recvProgress" class="progress-bar-fill"></div></div>
      <p id="recvTimeRemaining" class="text-sm text-gray-500 text-center mt-2"></p>
      
      <div id="receivingFileList" class="file-list hidden">
        <h3 class="font-bold mb-2">受信中のファイル:</h3>
        <ul id="receivingFileUl"></ul>
      </div>
      
      <div id="fileContainer" class="mt-4"></div>
      
      <!-- URL QRコードセクションを追加 -->
      <div class="mt-8 pt-4 border-t border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-bold">サイト共有</h3>
            <button id="toggleUrlQrBtn" class="text-blue-600 hover:text-blue-800 transition duration-200">最大化</button>
          </div>
          <div id="urlQrContainer" class="hidden">
            <div id="urlQrCanvas" class="flex justify-center mt-4"></div>
          </div>
      </div>
    </div>
  </div>

  <!-- WebTorrent と QRCode、html5-qrcodeライブラリの読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // WebTorrentクライアントを初期化
    const client = new WebTorrent();
    let qrReader; // QRコードリーダーのインスタンスを保持するための変数
    let wakeLock = null; // Wake Lockオブジェクトを保持する変数
    let sendProgressTimer;
    let recvProgressTimer;

    // Wake Lockを取得する関数
    async function acquireWakeLock() {
      if ('keepAwake' in screen) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log("Wake Lock acquired.");
          wakeLock.addEventListener('release', () => {
            console.log("Wake Lock released.");
          });
        } catch (err) {
          console.error(`Wake Lock failed: ${err.name}, ${err.message}`);
        }
      } else {
        console.log("Wake Lock API is not supported by this browser.");
      }
    }

    // Wake Lockを解放する関数
    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release()
          .then(() => {
            wakeLock = null;
          })
          .catch(err => {
            console.error("Wake Lock release failed:", err);
          });
      }
    }

    // カスタムアラート機能
    function showMessage(message) {
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
      modal.innerHTML = `
        <div class="relative p-8 bg-white w-96 max-w-sm rounded-lg shadow-xl text-center">
          <p class="text-lg font-semibold text-gray-800">${message}</p>
          <button onclick="this.parentElement.parentElement.remove();" class="mt-4 bg-[#008BF2] text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 transition duration-200">OK</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // プログレスバーを更新する関数
    function updateProgress(id, val) {
      document.getElementById(id).style.width = `${val}%`;
    }

    // 時間を秒単位から hh:mm:ss 形式にフォーマットする関数
    function formatTime(seconds) {
      if (seconds === Infinity || isNaN(seconds)) return "計算中...";
      if (seconds < 0) return "完了";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // カメラ一覧を読み込み、ドロップダウンメニューに追加する関数
    async function populateCameraList() {
        const cameraSelect = document.getElementById('cameraSelect');
        cameraSelect.innerHTML = ''; // リストをクリア
        try {
            const devices = await Html5Qrcode.getCameras();
            if (devices && devices.length) {
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.text = device.label || `Camera ${cameraSelect.length + 1}`;
                    cameraSelect.appendChild(option);
                });
            } else {
                showMessage("カメラが見つかりませんでした。");
            }
        } catch (err) {
            console.error("Failed to get camera devices:", err);
            showMessage("カメラデバイスの取得に失敗しました。");
        }
    }
    
    // ページロード時にカメラリストとURL QRコードを生成
    window.onload = () => {
        populateCameraList();
        generateUrlQrCode();
    };

    // ファイル送信ロジック
    document.getElementById('shareBtn').onclick = () => {
      const files = document.getElementById('fileInput').files;
      if (files.length === 0) {
        return showMessage("ファイルを選択してください");
      }

      // Wake Lockを取得
      acquireWakeLock();

      // 共有中のファイル一覧をUIに表示
      const sharingFileList = document.getElementById('sharingFileList');
      const sharingFileUl = document.getElementById('sharingFileUl');
      sharingFileList.classList.remove('hidden');
      sharingFileUl.innerHTML = ''; // リストをクリア
      for (const file of files) {
        const li = document.createElement('li');
        li.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        sharingFileUl.appendChild(li);
      }

      // 進捗状況を初期化
      updateProgress('sendProgress', 0);

      // マグネットリンク生成の進捗を表示
      updateProgress('sendProgress', 50);

      // 複数ファイルを一括でシード
      client.seed(Array.from(files), torrent => {
        const magnet = torrent.magnetURI;
        document.getElementById('magnetDisplay').value = magnet;
        
        // QRコード生成の進捗を表示
        updateProgress('sendProgress', 100);

        // 転送速度と残り時間の表示を更新
        sendProgressTimer = setInterval(() => {
          const uploaded = torrent.uploaded;
          const total = torrent.length;
          const uploadSpeed = torrent.uploadSpeed; // bytes/sec
          const numPeers = torrent.numPeers;
          
          if (numPeers === 0) {
              document.getElementById('sendTimeRemaining').textContent = "ピアを待機中...";
          } else if (uploadSpeed > 0) {
            const remainingBytes = total - uploaded;
            const timeRemaining = remainingBytes / uploadSpeed;
            document.getElementById('sendTimeRemaining').textContent = `アップロード速度: ${(uploadSpeed / 1024 / 1024).toFixed(2)} MB/s, 残り時間: ${formatTime(timeRemaining)}, ピア数: ${numPeers}`;
          } else {
            document.getElementById('sendTimeRemaining').textContent = `アップロード速度: 計算中..., ピア数: ${numPeers}`;
          }
        }, 1000);

        // 転送完了時にタイマーを停止
        torrent.on('done', () => {
          clearInterval(sendProgressTimer);
          document.getElementById('sendTimeRemaining').textContent = "完了しました。";
          // 転送完了時にWake Lockを解放
          releaseWakeLock();
        });
        
        // 転送の進捗を更新
        torrent.on('upload', () => {
            // ここでは何も実行しない
        });

        // QRコードを生成して表示
        QRCode.toCanvas(document.createElement('canvas'), magnet, { width: 256 }, (err, canvas) => {
          if (!err) {
            const qrArea = document.getElementById('qrCanvas');
            qrArea.innerHTML = '';
            qrArea.appendChild(canvas);
          }
        });
      });
    };

    // ファイル受信ロジック
    document.getElementById('downloadBtn').onclick = () => {
      const uri = document.getElementById('magnetInput').value.trim();
      if (!uri) {
        return showMessage("magnet URI を入力してください");
      }

      // Wake Lockを取得
      acquireWakeLock();

      updateProgress('recvProgress', 10);

      client.add(uri, torrent => {
        // 受信中のファイル一覧をUIに表示
        const receivingFileList = document.getElementById('receivingFileList');
        const receivingFileUl = document.getElementById('receivingFileUl');
        receivingFileList.classList.remove('hidden');
        receivingFileUl.innerHTML = ''; // リストをクリア
        torrent.files.forEach(file => {
          const li = document.createElement('li');
          li.textContent = `${file.name} (${(file.length / 1024 / 1024).toFixed(2)} MB)`;
          receivingFileUl.appendChild(li);
        });
        
        // 転送速度と残り時間の表示を更新
        recvProgressTimer = setInterval(() => {
          const downloaded = torrent.downloaded;
          const total = torrent.length;
          const downloadSpeed = torrent.downloadSpeed; // bytes/sec
          const numPeers = torrent.numPeers;

          if (numPeers === 0) {
              document.getElementById('recvTimeRemaining').textContent = "ピアを待機中...";
          } else if (downloadSpeed > 0) {
            const remainingBytes = total - downloaded;
            const timeRemaining = remainingBytes / downloadSpeed;
            document.getElementById('recvTimeRemaining').textContent = `ダウンロード速度: ${(downloadSpeed / 1024 / 1024).toFixed(2)} MB/s, 残り時間: ${formatTime(timeRemaining)}, ピア数: ${numPeers}`;
          } else {
            document.getElementById('recvTimeRemaining').textContent = `ダウンロード速度: 計算中..., ピア数: ${numPeers}`;
          }
        }, 1000);

        // 全ファイルのダウンロードが完了したら実行
        torrent.on('done', () => {
          updateProgress('recvProgress', 100);
          clearInterval(recvProgressTimer);
          document.getElementById('recvTimeRemaining').textContent = "完了しました。";
          // 転送完了時にWake Lockを解放
          releaseWakeLock();

          torrent.files.forEach(file => {
            file.getBlob((err, blob) => {
              if (err) return showMessage("ダウンロードエラー");
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = file.name;
              a.textContent = `ダウンロード: ${file.name}`;
              a.className = "block text-blue-600 hover:text-blue-800 transition duration-200 mt-2 break-all";
              document.getElementById('fileContainer').appendChild(a);
            });
          });
        });

        // ダウンロードの進捗を更新
        torrent.on('download', () => {
          updateProgress('recvProgress', Math.floor(torrent.progress * 100));
        });
      });
    };

    // QRコードスキャンロジック
    document.getElementById('scanBtn').onclick = () => {
      const cameraSelect = document.getElementById('cameraSelect');
      const selectedCameraId = cameraSelect.value;
      if (!selectedCameraId) {
        return showMessage("カメラが選択されていません。");
      }

      // 前回のスキャンがまだ実行中の場合は停止
      if (qrReader && qrReader.isScanning) {
          qrReader.stop().catch(e => console.error("カメラ停止エラー:", e));
      }
      
      const readerContainer = document.getElementById('reader');
      qrReader = new Html5Qrcode("reader");
      qrReader.start(
        selectedCameraId, // 選択されたカメラのIDを使用
        { fps: 10, qrbox: { width: 250, height: 250 } },
        decoded => {
          qrReader.stop().catch(e => console.error("カメラ停止エラー:", e));
          document.getElementById('magnetInput').value = decoded;
        },
        err => {
            // エラーをログに出力
            console.error("QRスキャンエラー:", err);
            // エラーメッセージをユーザーに表示
            // showMessage("QRコードスキャン中にエラーが発生しました。");
        }
      ).catch(e => {
          showMessage("カメラ起動に失敗しました: " + e);
          console.error("カメラ起動エラー:", e);
      });
    };
    
    // 現在のサイトURLのQRコードを生成する関数
    function generateUrlQrCode() {
        const currentUrl = window.location.href;
        const qrArea = document.getElementById('urlQrCanvas');
        if (qrArea) {
            QRCode.toCanvas(document.createElement('canvas'), currentUrl, { width: 256 }, (err, canvas) => {
              if (!err) {
                qrArea.innerHTML = '';
                qrArea.appendChild(canvas);
              }
            });
        }
    }

    // URL QRコードの表示/非表示を切り替える機能
    document.getElementById('toggleUrlQrBtn').onclick = () => {
        const urlQrContainer = document.getElementById('urlQrContainer');
        const toggleBtn = document.getElementById('toggleUrlQrBtn');
        if (urlQrContainer.classList.contains('hidden')) {
            urlQrContainer.classList.remove('hidden');
            toggleBtn.textContent = '最小化';
        } else {
            urlQrContainer.classList.add('hidden');
            toggleBtn.textContent = '最大化';
        }
    };

    // PWA (Progressive Web App) の Service Worker を登録
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log("SW registered:", reg))
        .catch(err => console.error("SW registration failed:", err));
    }
  </script>
</body>
</html>
